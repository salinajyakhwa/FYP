{% extends 'base.html' %}

{% block title %}Vendor Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Vendor Dashboard</h1>

    <!-- Stat Cards -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card text-white bg-success shadow-sm">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-cash-coin"></i> Total Revenue</h5>
                    <p class="card-text fs-3 fw-bold">${{ total_revenue|floatformat:2 }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card text-white bg-primary shadow-sm">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-ticket-perforated-fill"></i> Total Bookings</h5>
                    <p class="card-text fs-3 fw-bold">{{ total_bookings_count }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <!-- Monthly Revenue Chart -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    Monthly Revenue (Last 12 Months)
                </div>
                <div class="card-body">
                    <canvas id="monthlyRevenueChart"></canvas>
                </div>
            </div>
        </div>
        <!-- Bookings by Package Chart -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    Top 5 Packages by Bookings
                </div>
                <div class="card-body">
                    <canvas id="packageBookingsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Package List Section -->
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Your Packages</h5>
            <a href="{% url 'create_package' %}" class="btn btn-primary btn-sm">
                <i class="bi bi-plus-circle-fill"></i> Create New Package
            </a>
        </div>
        <div class="card-body">
            <!-- Search form can go here if you want to keep it -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Package Name</th>
                            <th>Location</th>
                            <th>Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for package in packages %}
                        <tr>
                            <td>{{ package.name }}</td>
                            <td>{{ package.location }}</td>
                            <td>${{ package.price|floatformat:2 }}</td>
                            <td>
                                <a href="{% url 'package_detail' package.id %}" class="btn btn-sm btn-outline-secondary">View</a>
                                <a href="{% url 'manage_itinerary' package.id %}" class="btn btn-sm btn-outline-primary">Manage Itinerary</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center">You have not created any packages yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Safely parse the JSON data from the template
    const monthlyRevenueLabels = JSON.parse('{{ monthly_revenue_labels|escapejs }}');
    const monthlyRevenueValues = JSON.parse('{{ monthly_revenue_values|escapejs }}');
    const packageBookingLabels = JSON.parse('{{ package_booking_labels|escapejs }}');
    const packageBookingValues = JSON.parse('{{ package_booking_values|escapejs }}');

    // 1. Monthly Revenue Chart (Line Chart)
    const monthlyCtx = document.getElementById('monthlyRevenueChart').getContext('2d');
    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: monthlyRevenueLabels,
            datasets: [{
                label: 'Revenue ($)',
                data: monthlyRevenueValues,
                backgroundColor: 'rgba(40, 167, 69, 0.2)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 2,
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value, index, values) {
                            return '$' + value;
                        }
                    }
                }
            }
        }
    });

    // 2. Bookings by Package Chart (Doughnut Chart)
    const packageCtx = document.getElementById('packageBookingsChart').getContext('2d');
    new Chart(packageCtx, {
        type: 'doughnut',
        data: {
            labels: packageBookingLabels,
            datasets: [{
                label: 'Number of Bookings',
                data: packageBookingValues,
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(23, 162, 184, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(220, 53, 69, 0.8)',
                    'rgba(108, 117, 125, 0.8)'
                ],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
        }
    });
});
</script>
{% endblock %}
