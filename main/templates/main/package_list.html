{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Explore Journeys | TravelBooker{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --brand-primary: #1b4332; /* Deep Forest */
        --brand-accent: #2d6a4f;  /* Medium Sea */
        --brand-light: #f0fdf4;   /* Mint Mist */
        --text-main: #1a1c1e;
        --text-muted: #64748b;
        --surface: #ffffff;
        --border-color: #e2e8f0;
        --radius-lg: 16px;
        --radius-md: 12px;
        --shadow-subtle: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
    }

    body { 
        background-color: #f8faf9; 
        font-family: 'Plus Jakarta Sans', sans-serif;
        color: var(--text-main);
    }

    /* ðŸŒ¿ Seamless Hero & Search */
    .hero-wrap {
        background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('/static/images/hero.jpg') center/cover no-repeat;
        height: 320px;
        display: flex;
        align-items: center;
        border-bottom-left-radius: 40px;
        border-bottom-right-radius: 40px;
        margin-bottom: -60px; /* Pulls search bar up */
    }

    .search-container {
        background: var(--surface);
        padding: 30px;
        border-radius: var(--radius-lg);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-color);
        position: relative;
        z-index: 10;
    }

    .form-label {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 8px;
    }

    .input-pro {
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 12px 16px;
        font-size: 0.9rem;
        background-color: #fcfdfe;
        transition: all 0.2s;
    }

    .input-pro:focus {
        border-color: var(--brand-accent);
        box-shadow: 0 0 0 4px rgba(45, 106, 79, 0.1);
        background-color: #fff;
    }

    /* ðŸŒ¿ Results Toolbar */
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-top: 100px; /* Space for overlapped search */
        margin-bottom: 24px;
    }

    /* ðŸŒ¿ Floating Compare Bar (The "Pro" Feature) */
    #compare-drawer {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%) translateY(150%);
        background: var(--brand-primary);
        color: white;
        padding: 16px 32px;
        border-radius: 100px;
        display: flex;
        align-items: center;
        gap: 20px;
        z-index: 1000;
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    #compare-drawer.active { transform: translateX(-50%) translateY(0); }

    .compare-btn-pill {
        background: #fff;
        color: var(--brand-primary);
        border: none;
        padding: 8px 20px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.85rem;
        transition: background 0.2s;
    }

    .compare-btn-pill:hover { background: var(--brand-light); }

    /* ðŸŒ¿ Pagination Styling */
    .page-link {
        border: none;
        color: var(--text-muted);
        padding: 10px 18px;
        font-weight: 600;
        border-radius: 8px !important;
        margin: 0 4px;
    }

    .page-item.active .page-link {
        background-color: var(--brand-primary);
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="hero-wrap">
    <div class="container text-center text-white">
        <h1 class="display-5 fw-bold mb-2">Find Your Perfect Journey</h1>
        <p class="opacity-75">Curated experiences from trusted local experts</p>
    </div>
</div>

<div class="container">
    <!-- ðŸŒ¿ Advanced Filter Bar -->
    <div class="search-container">
        <form method="get" class="row g-3">
            <div class="col-lg-3 col-md-6">
                <label class="form-label">Where to?</label>
                {% render_field filter.form.location class="form-control input-pro" placeholder="Destination name..." %}
            </div>
            <div class="col-lg-2 col-md-6">
                <label class="form-label">Travel Type</label>
                {% render_field filter.form.travel_type class="form-select input-pro" %}
            </div>
            <div class="col-lg-3 col-md-6">
                <label class="form-label">Price Range</label>
                <div class="input-group">
                    {% render_field filter.form.price__gt class="form-control input-pro" placeholder="Min" %}
                    {% render_field filter.form.price__lt class="form-control input-pro" placeholder="Max" %}
                </div>
            </div>
            <div class="col-lg-2 col-md-6">
                <label class="form-label">Timeline</label>
                {% render_field filter.form.start_date__gt class="form-control input-pro" type="date" %}
            </div>
            <div class="col-lg-2 col-md-12 d-flex align-items-end">
                <button type="submit" class="btn btn-dark w-100 py-2 fw-bold" style="border-radius: 12px; background: var(--brand-primary);">
                    Search
                </button>
            </div>
        </form>
    </div>

    <!-- ðŸŒ¿ Results Header -->
    <div class="toolbar">
        <div>
            <h4 class="fw-bold mb-0">Discover Packages</h4>
            <p class="text-muted small mb-0">{{ packages.paginator.count }} unique journeys found</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'package_list' %}" class="btn btn-sm btn-outline-secondary rounded-pill px-3">Clear Filters</a>
        </div>
    </div>

    <!-- ðŸŒ¿ Grid -->
    <form id="compare-form" action="{% url 'compare_packages' %}" method="post">
        {% csrf_token %}
        <div class="row g-4">
            {% include "main/_package_list_partial.html" %}
        </div>

        <!-- ðŸŒ¿ Sticky Compare Notification Bar -->
        <div id="compare-drawer">
            <span class="small fw-medium"><span id="compare-count">0</span> packages selected for comparison</span>
            <button type="submit" class="compare-btn-pill">Compare Now</button>
            <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.7rem;" onclick="uncheckAll()"></button>
        </div>
    </form>

    <!-- ðŸŒ¿ Pagination -->
    {% if packages.has_other_pages %}
    <nav class="py-5">
        <ul class="pagination justify-content-center">
            {% if packages.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ packages.previous_page_number }}"><i class="bi bi-chevron-left"></i></a>
            </li>
            {% endif %}
            
            <li class="page-item active"><span class="page-link">{{ packages.number }}</span></li>
            
            {% if packages.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ packages.next_page_number }}"><i class="bi bi-chevron-right"></i></a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    const drawer = document.getElementById('compare-drawer');
    const countSpan = document.getElementById('compare-count');
    const checkboxes = document.querySelectorAll('.compare-checkbox');

    function updateDrawer() {
        const checked = document.querySelectorAll('.compare-checkbox:checked');
        const count = checked.length;
        
        countSpan.innerText = count;
        
        if (count >= 1) {
            drawer.classList.add('active');
        } else {
            drawer.classList.remove('active');
        }
    }

    function uncheckAll() {
        checkboxes.forEach(cb => cb.checked = false);
        updateDrawer();
    }

    checkboxes.forEach(cb => cb.addEventListener('change', updateDrawer));
</script>
{% endblock %}